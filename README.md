# Микросервисы аутентификации и транзакции

## Содержание

- [Обзор](#обзор)
- [Архитектура](#архитектура)
- [Требования](#требования)
- [Установка и настройка](#установка-и-настройка)
  - [Клонирование репозитория](#клонирование-репозитория)
  - [Переменные Окружения](#переменные-окружения)
  - [Docker Compose](#docker-compose)
- [Сборка и запуск](#запуск-сервисов)
- [Логирование](#логирование)
- [Миграции базы данных](#миграции-базы-данных)

## Обзор

Этот проект состоит из двух основных микросервисов:

1. **Микросервис аутентификации**: Обрабатывает регистрацию пользователей, аутентификацию и управление токенами.
2. **Микросервис транзакций**: Управляет финансовыми транзакциями между пользователями, включая перевод средств и получение истории транзакций.

Оба сервиса построены с использованием **FastAPI**, **SQLAlchemy (Async)** и контейнеризованы с помощью **Docker** для удобного развертывания и масштабирования.

## Архитектура

- **Микросервис аутентификации**:
  - **API Эндпоинты**:
    - `/register`: Регистрация нового пользователя.
    - `/token`: Аутентификация пользователя и выдача JWT токена.
    - `/change-password`: Смена пароля пользователя.
    - `/verify`: Проверка аутентификации пользователя
    - `/check-user`: Проверка зарегистрированного пользователя
- **Микросервис транзакций**:
  - **Эндпоинты**:
    - `/transfer`: Перевод средств от аутентифицированного пользователя другому зарегестрированному пользователю.
      - *Проверяет аутентификацию пользователя через `/verify`*
      - *Проверяет регистрацию получателя через `/check-user`*
      - *Проверяет созданы ли аккаунты (если нет, то создает)*
      - *Проверяет достаточность средств*
      - *Совершает транзакцию*
    - `/transactions`: Получение истории транзакций аутентифицированного пользователя.
      - *Список выдается отсортированный по убываюнию даты*
      - *Есть возможность пагинации через `skip` (сколько первых транзакций пропустить) и `limit` (сколько максимум выдавать транзакций, по умолчанию задается в `config.py`)*

**Важно**: Т.к. нет микросервиса со счетами пользователей, то аккуаунт заводиться (_с небольшой стартовой суммой по умолчанию_) при первой попытки перевести или получить средства и храниться в микросервисе транзакциий. 

Оба сервиса асинхронно взаимодействуют с соответствующими базами данных PostgreSQL и обеспечивают безопасное общение с использованием JWT токенов.

## Требования

- **Docker**: [Установите Docker](https://docs.docker.com/get-docker/)
- **Docker Compose**: [Установите Docker Compose](https://docs.docker.com/compose/install/)
- **Git**: [Установите Git](https://git-scm.com/downloads)

## Установка и настройка

### Клонирование репозитория

```bash
git clone https://github.com/mikhio/auth_trans_app.git 
cd auth_trans_app 
```

### Переменные окружения

Для простоты микросервисы имеют общие перемнные окружния (`.env`), т.к
собираются через Docker Compose.

Пример настройки дан в файле: `.env_example`

### Docker Compose

Файл `docker-compose.yml` оркестрирует весь проект, включая базы данных и оба микросервиса.

## Сборка и запуск

1. **Соберите и запустите контейнеры**

    ```bash
    docker-compose up --build
    ```

    Эта команда соберёт Docker образы для обоих микросервисов, настроит базы данных PostgreSQL и запустит все сервисы.

2. **Доступ к Сервисам**

    - **Микросервис аутентификации**: [http://localhost:8000/docs](http://localhost:8000/docs)
    - **Микросервис транзакций**: [http://localhost:8001/docs](http://localhost:8001/docs)

    Эндпоинты `/docs` предоставляют интерактивную документацию API через Swagger UI.


## Логирование

Логи каждого микросервиса хранятся в отдельных директориях на хосте:

- **Логи микросервиса аутентификации**: `logs/auth_service/auth_service.log`
- **Логи микросервиса транзакций**: `logs/transaction_service/transaction_service.log`

Эти логи монтируются на хост, обеспечивая их сохранность и удобный доступ для мониторинга и отладки.

### Просмотр логов

```bash
# Просмотр логов Микросервиса Аутентификации
cat logs/auth_service/auth_service.log

# Просмотр логов Микросервиса Транзакций
cat logs/transaction_service/transaction_service.log
```

## Миграции базы данных

Оба микросервиса используют **Alembic** для управления миграциями базы данных.
Для автоматизации будут созданы отдельные контейнеры на основе контекстов микросервисов,
в которых будет автоматическое создание и применение миграций, причем `alembic/versions`
монтированы на хост.


### Создание новой миграции вручную
Если все же хочется создать миграцию вручную и отключить автоматическое.

То для этого нужно закомментировать `auth_migrate` и/или `transaction_migrate` в
`docker-compose.yml`.

И например:

```bash
docker exec -it <container_name> bash
alembic revision --autogenerate -m "Migration"
alembic upgrade head
```
---